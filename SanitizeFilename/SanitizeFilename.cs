using System.Globalization;
using System.Text;

namespace Codeuctivity
{
    /// <summary>
    /// Sanitizes a filename by replacing invalid chars with a replacement char. Follows rules defined in https://docs.microsoft.com/en-us/windows/win32/fileio/naming-a-file
    /// </summary>
    public static class SanitizeFilename
    {
        /// <summary>
        /// These are the reserved names in Windows. See https://docs.microsoft.com/en-us/windows/win32/fileio/naming-a-file. While .net can write alle of these filenames on modern environments (except PRN), there are many application that will refuse to read them.
        /// </summary>
        public static readonly string[] ReservedWindowsFileNames = ["CON", "PRN", "AUX", "NUL", "COM0", "COM1", "COM2", "COM3", "COM4", "COM5", "COM6", "COM7", "COM8", "COM9", "COM\u00B9", "COM\u00B2", "COM\u00B3", "LPT0", "LPT1", "LPT2", "LPT3", "LPT4", "LPT5", "LPT6", "LPT7", "LPT8", "LPT9", "LPT\u00B9", "LPT\u00B2", "LPT\u00B3"];

        /// <summary>
        /// Values of reserved windows file names with extension. See https://docs.microsoft.com/en-us/windows/win32/fileio/naming-a-file. While .net can write alle of these filenames on modern environments (except PRN), there are many application that will refuse to read them.
        /// </summary>
        public static readonly string[] ReservedWindowsFileNamesWithExtension = ["CON.", "PRN.", "AUX.", "NUL.", "COM0.", "COM1.", "COM2.", "COM3.", "COM4.", "COM5.", "COM6.", "COM7.", "COM8.", "COM9.", "COM\u00B9.", "COM\u00B2.", "COM\u00B3.", "LPT0.", "LPT1.", "LPT2.", "LPT3.", "LPT4.", "LPT5.", "LPT6.", "LPT7.", "LPT8.", "LPT9.", "LPT\u00B9.", "LPT\u00B2.", "LPT\u00B3."];

        public static readonly char[] InvalidCharsInWindowsFileNames = ['\\',
            '/',
            '\"',
            '<',
            '>',
            '|',
            ':',
            '*',
            '?',
            '\0',
            (char)1,
            (char)2,
            (char)3,
            (char)4,
            (char)5,
            (char)6,
            (char)7,
            (char)8,
            (char)9,
            (char)10,
            (char)11,
            (char)12,
            (char)13,
            (char)14,
            (char)15,
            (char)16,
            (char)17,
            (char)18,
            (char)19,
            (char)20,
            (char)21,
            (char)22,
            (char)23,
            (char)24,
            (char)25,
            (char)26,
            (char)27,
            (char)28,
            (char)29,
            (char)30,
            (char)31,
        ];

        /// <summary>
        /// Chars that trigger an System.IO.IOException: 'Illegal byte sequence' on MacOs, these are all in the UnicodeCategory.OtherNotAssigned category (with two exceptions), see https://docs.microsoft.com/en-us/dotnet/api/system.globalization.unicodecategory
        /// </summary>
        public static readonly char[] InvalidCharsInMacOsFileNames = [
            //NonSpacingMark
            (char)3790,
            //SpacingCombiningMark
            (char)3315,
            //OtherNotAssigned
            (char)888,
            (char)889,
            (char)896,
            (char)897,
            (char)898,
            (char)899,
            (char)907,
            (char)909,
            (char)930,
            (char)1328,
            (char)1367,
            (char)1368,
            (char)1419,
            (char)1420,
            (char)1424,
            (char)1480,
            (char)1481,
            (char)1482,
            (char)1483,
            (char)1484,
            (char)1485,
            (char)1486,
            (char)1487,
            (char)1515,
            (char)1516,
            (char)1517,
            (char)1518,
            (char)1525,
            (char)1526,
            (char)1527,
            (char)1528,
            (char)1529,
            (char)1530,
            (char)1531,
            (char)1532,
            (char)1533,
            (char)1534,
            (char)1535,
            (char)1806,
            (char)1867,
            (char)1868,
            (char)1970,
            (char)1971,
            (char)1972,
            (char)1973,
            (char)1974,
            (char)1975,
            (char)1976,
            (char)1977,
            (char)1978,
            (char)1979,
            (char)1980,
            (char)1981,
            (char)1982,
            (char)1983,
            (char)2043,
            (char)2044,
            (char)2094,
            (char)2095,
            (char)2111,
            (char)2140,
            (char)2141,
            (char)2143,
            (char)2155,
            (char)2156,
            (char)2157,
            (char)2158,
            (char)2159,
            (char)2191,
            (char)2194,
            (char)2195,
            (char)2196,
            (char)2197,
            (char)2198,
            (char)2199,
            (char)2436,
            (char)2445,
            (char)2446,
            (char)2449,
            (char)2450,
            (char)2473,
            (char)2481,
            (char)2483,
            (char)2484,
            (char)2485,
            (char)2490,
            (char)2491,
            (char)2501,
            (char)2502,
            (char)2505,
            (char)2506,
            (char)2511,
            (char)2512,
            (char)2513,
            (char)2514,
            (char)2515,
            (char)2516,
            (char)2517,
            (char)2518,
            (char)2520,
            (char)2521,
            (char)2522,
            (char)2523,
            (char)2526,
            (char)2532,
            (char)2533,
            (char)2559,
            (char)2560,
            (char)2564,
            (char)2571,
            (char)2572,
            (char)2573,
            (char)2574,
            (char)2577,
            (char)2578,
            (char)2601,
            (char)2609,
            (char)2612,
            (char)2615,
            (char)2618,
            (char)2619,
            (char)2621,
            (char)2627,
            (char)2628,
            (char)2629,
            (char)2630,
            (char)2633,
            (char)2634,
            (char)2638,
            (char)2639,
            (char)2640,
            (char)2642,
            (char)2643,
            (char)2644,
            (char)2645,
            (char)2646,
            (char)2647,
            (char)2648,
            (char)2653,
            (char)2655,
            (char)2656,
            (char)2657,
            (char)2658,
            (char)2659,
            (char)2660,
            (char)2661,
            (char)2679,
            (char)2680,
            (char)2681,
            (char)2682,
            (char)2683,
            (char)2684,
            (char)2685,
            (char)2686,
            (char)2687,
            (char)2688,
            (char)2692,
            (char)2702,
            (char)2706,
            (char)2729,
            (char)2737,
            (char)2740,
            (char)2746,
            (char)2747,
            (char)2758,
            (char)2762,
            (char)2766,
            (char)2767,
            (char)2769,
            (char)2770,
            (char)2771,
            (char)2772,
            (char)2773,
            (char)2774,
            (char)2775,
            (char)2776,
            (char)2777,
            (char)2778,
            (char)2779,
            (char)2780,
            (char)2781,
            (char)2782,
            (char)2783,
            (char)2788,
            (char)2789,
            (char)2802,
            (char)2803,
            (char)2804,
            (char)2805,
            (char)2806,
            (char)2807,
            (char)2808,
            (char)2816,
            (char)2820,
            (char)2829,
            (char)2830,
            (char)2833,
            (char)2834,
            (char)2857,
            (char)2865,
            (char)2868,
            (char)2874,
            (char)2875,
            (char)2885,
            (char)2886,
            (char)2889,
            (char)2890,
            (char)2894,
            (char)2895,
            (char)2896,
            (char)2897,
            (char)2898,
            (char)2899,
            (char)2900,
            (char)2904,
            (char)2905,
            (char)2906,
            (char)2907,
            (char)2910,
            (char)2916,
            (char)2917,
            (char)2936,
            (char)2937,
            (char)2938,
            (char)2939,
            (char)2940,
            (char)2941,
            (char)2942,
            (char)2943,
            (char)2944,
            (char)2945,
            (char)2948,
            (char)2955,
            (char)2956,
            (char)2957,
            (char)2961,
            (char)2966,
            (char)2967,
            (char)2968,
            (char)2971,
            (char)2973,
            (char)2976,
            (char)2977,
            (char)2978,
            (char)2981,
            (char)2982,
            (char)2983,
            (char)2987,
            (char)2988,
            (char)2989,
            (char)3002,
            (char)3003,
            (char)3004,
            (char)3005,
            (char)3011,
            (char)3012,
            (char)3013,
            (char)3017,
            (char)3022,
            (char)3023,
            (char)3025,
            (char)3026,
            (char)3027,
            (char)3028,
            (char)3029,
            (char)3030,
            (char)3032,
            (char)3033,
            (char)3034,
            (char)3035,
            (char)3036,
            (char)3037,
            (char)3038,
            (char)3039,
            (char)3040,
            (char)3041,
            (char)3042,
            (char)3043,
            (char)3044,
            (char)3045,
            (char)3067,
            (char)3068,
            (char)3069,
            (char)3070,
            (char)3071,
            (char)3085,
            (char)3089,
            (char)3113,
            (char)3130,
            (char)3131,
            (char)3141,
            (char)3145,
            (char)3150,
            (char)3151,
            (char)3152,
            (char)3153,
            (char)3154,
            (char)3155,
            (char)3156,
            (char)3159,
            (char)3163,
            (char)3164,
            (char)3166,
            (char)3167,
            (char)3172,
            (char)3173,
            (char)3184,
            (char)3185,
            (char)3186,
            (char)3187,
            (char)3188,
            (char)3189,
            (char)3190,
            (char)3213,
            (char)3217,
            (char)3241,
            (char)3252,
            (char)3258,
            (char)3259,
            (char)3269,
            (char)3273,
            (char)3278,
            (char)3279,
            (char)3280,
            (char)3281,
            (char)3282,
            (char)3283,
            (char)3284,
            (char)3287,
            (char)3288,
            (char)3289,
            (char)3290,
            (char)3291,
            (char)3292,
            (char)3295,
            (char)3300,
            (char)3301,
            (char)3312,
            (char)3316,
            (char)3317,
            (char)3318,
            (char)3319,
            (char)3320,
            (char)3321,
            (char)3322,
            (char)3323,
            (char)3324,
            (char)3325,
            (char)3326,
            (char)3327,
            (char)3341,
            (char)3345,
            (char)3397,
            (char)3401,
            (char)3408,
            (char)3409,
            (char)3410,
            (char)3411,
            (char)3428,
            (char)3429,
            (char)3456,
            (char)3460,
            (char)3479,
            (char)3480,
            (char)3481,
            (char)3506,
            (char)3516,
            (char)3518,
            (char)3519,
            (char)3527,
            (char)3528,
            (char)3529,
            (char)3531,
            (char)3532,
            (char)3533,
            (char)3534,
            (char)3541,
            (char)3543,
            (char)3552,
            (char)3553,
            (char)3554,
            (char)3555,
            (char)3556,
            (char)3557,
            (char)3568,
            (char)3569,
            (char)3573,
            (char)3574,
            (char)3575,
            (char)3576,
            (char)3577,
            (char)3578,
            (char)3579,
            (char)3580,
            (char)3581,
            (char)3582,
            (char)3583,
            (char)3584,
            (char)3643,
            (char)3644,
            (char)3645,
            (char)3646,
            (char)3676,
            (char)3677,
            (char)3678,
            (char)3679,
            (char)3680,
            (char)3681,
            (char)3682,
            (char)3683,
            (char)3684,
            (char)3685,
            (char)3686,
            (char)3687,
            (char)3688,
            (char)3689,
            (char)3690,
            (char)3691,
            (char)3692,
            (char)3693,
            (char)3694,
            (char)3695,
            (char)3696,
            (char)3697,
            (char)3698,
            (char)3699,
            (char)3700,
            (char)3701,
            (char)3702,
            (char)3703,
            (char)3704,
            (char)3705,
            (char)3706,
            (char)3707,
            (char)3708,
            (char)3709,
            (char)3710,
            (char)3711,
            (char)3712,
            (char)3715,
            (char)3717,
            (char)3723,
            (char)3748,
            (char)3750,
            (char)3774,
            (char)3775,
            (char)3781,
            (char)3783,
            (char)3791,
            (char)3802,
            (char)3803,
            (char)3808,
            (char)3809,
            (char)3810,
            (char)3811,
            (char)3812,
            (char)3813,
            (char)3814,
            (char)3815,
            (char)3816,
            (char)3817,
            (char)3818,
            (char)3819,
            (char)3820,
            (char)3821,
            (char)3822,
            (char)3823,
            (char)3824,
            (char)3825,
            (char)3826,
            (char)3827,
            (char)3828,
            (char)3829,
            (char)3830,
            (char)3831,
            (char)3832,
            (char)3833,
            (char)3834,
            (char)3835,
            (char)3836,
            (char)3837,
            (char)3838,
            (char)3839,
            (char)3912,
            (char)3949,
            (char)3950,
            (char)3951,
            (char)3952,
            (char)3992,
            (char)4029,
            (char)4045,
            (char)4059,
            (char)4060,
            (char)4061,
            (char)4062,
            (char)4063,
            (char)4064,
            (char)4065,
            (char)4066,
            (char)4067,
            (char)4068,
            (char)4069,
            (char)4070,
            (char)4071,
            (char)4072,
            (char)4073,
            (char)4074,
            (char)4075,
            (char)4076,
            (char)4077,
            (char)4078,
            (char)4079,
            (char)4080,
            (char)4081,
            (char)4082,
            (char)4083,
            (char)4084,
            (char)4085,
            (char)4086,
            (char)4087,
            (char)4088,
            (char)4089,
            (char)4090,
            (char)4091,
            (char)4092,
            (char)4093,
            (char)4094,
            (char)4095,
            (char)4294,
            (char)4296,
            (char)4297,
            (char)4298,
            (char)4299,
            (char)4300,
            (char)4302,
            (char)4303,
            (char)4681,
            (char)4686,
            (char)4687,
            (char)4695,
            (char)4697,
            (char)4702,
            (char)4703,
            (char)4745,
            (char)4750,
            (char)4751,
            (char)4785,
            (char)4790,
            (char)4791,
            (char)4799,
            (char)4801,
            (char)4806,
            (char)4807,
            (char)4823,
            (char)4881,
            (char)4886,
            (char)4887,
            (char)4955,
            (char)4956,
            (char)4989,
            (char)4990,
            (char)4991,
            (char)5018,
            (char)5019,
            (char)5020,
            (char)5021,
            (char)5022,
            (char)5023,
            (char)5110,
            (char)5111,
            (char)5118,
            (char)5119,
            (char)5789,
            (char)5790,
            (char)5791,
            (char)5881,
            (char)5882,
            (char)5883,
            (char)5884,
            (char)5885,
            (char)5886,
            (char)5887,
            (char)5910,
            (char)5911,
            (char)5912,
            (char)5913,
            (char)5914,
            (char)5915,
            (char)5916,
            (char)5917,
            (char)5918,
            (char)5943,
            (char)5944,
            (char)5945,
            (char)5946,
            (char)5947,
            (char)5948,
            (char)5949,
            (char)5950,
            (char)5951,
            (char)5972,
            (char)5973,
            (char)5974,
            (char)5975,
            (char)5976,
            (char)5977,
            (char)5978,
            (char)5979,
            (char)5980,
            (char)5981,
            (char)5982,
            (char)5983,
            (char)5997,
            (char)6001,
            (char)6004,
            (char)6005,
            (char)6006,
            (char)6007,
            (char)6008,
            (char)6009,
            (char)6010,
            (char)6011,
            (char)6012,
            (char)6013,
            (char)6014,
            (char)6015,
            (char)6110,
            (char)6111,
            (char)6122,
            (char)6123,
            (char)6124,
            (char)6125,
            (char)6126,
            (char)6127,
            (char)6138,
            (char)6139,
            (char)6140,
            (char)6141,
            (char)6142,
            (char)6143,
            (char)6170,
            (char)6171,
            (char)6172,
            (char)6173,
            (char)6174,
            (char)6175,
            (char)6265,
            (char)6266,
            (char)6267,
            (char)6268,
            (char)6269,
            (char)6270,
            (char)6271,
            (char)6315,
            (char)6316,
            (char)6317,
            (char)6318,
            (char)6319,
            (char)6390,
            (char)6391,
            (char)6392,
            (char)6393,
            (char)6394,
            (char)6395,
            (char)6396,
            (char)6397,
            (char)6398,
            (char)6399,
            (char)6431,
            (char)6444,
            (char)6445,
            (char)6446,
            (char)6447,
            (char)6460,
            (char)6461,
            (char)6462,
            (char)6463,
            (char)6465,
            (char)6466,
            (char)6467,
            (char)6510,
            (char)6511,
            (char)6517,
            (char)6518,
            (char)6519,
            (char)6520,
            (char)6521,
            (char)6522,
            (char)6523,
            (char)6524,
            (char)6525,
            (char)6526,
            (char)6527,
            (char)6572,
            (char)6573,
            (char)6574,
            (char)6575,
            (char)6602,
            (char)6603,
            (char)6604,
            (char)6605,
            (char)6606,
            (char)6607,
            (char)6619,
            (char)6620,
            (char)6621,
            (char)6684,
            (char)6685,
            (char)6751,
            (char)6781,
            (char)6782,
            (char)6794,
            (char)6795,
            (char)6796,
            (char)6797,
            (char)6798,
            (char)6799,
            (char)6810,
            (char)6811,
            (char)6812,
            (char)6813,
            (char)6814,
            (char)6815,
            (char)6830,
            (char)6831,
            (char)6863,
            (char)6864,
            (char)6865,
            (char)6866,
            (char)6867,
            (char)6868,
            (char)6869,
            (char)6870,
            (char)6871,
            (char)6872,
            (char)6873,
            (char)6874,
            (char)6875,
            (char)6876,
            (char)6877,
            (char)6878,
            (char)6879,
            (char)6880,
            (char)6881,
            (char)6882,
            (char)6883,
            (char)6884,
            (char)6885,
            (char)6886,
            (char)6887,
            (char)6888,
            (char)6889,
            (char)6890,
            (char)6891,
            (char)6892,
            (char)6893,
            (char)6894,
            (char)6895,
            (char)6896,
            (char)6897,
            (char)6898,
            (char)6899,
            (char)6900,
            (char)6901,
            (char)6902,
            (char)6903,
            (char)6904,
            (char)6905,
            (char)6906,
            (char)6907,
            (char)6908,
            (char)6909,
            (char)6910,
            (char)6911,
            (char)6989,
            (char)6990,
            (char)6991,
            (char)7039,
            (char)7156,
            (char)7157,
            (char)7158,
            (char)7159,
            (char)7160,
            (char)7161,
            (char)7162,
            (char)7163,
            (char)7224,
            (char)7225,
            (char)7226,
            (char)7242,
            (char)7243,
            (char)7244,
            (char)7305,
            (char)7306,
            (char)7307,
            (char)7308,
            (char)7309,
            (char)7310,
            (char)7311,
            (char)7355,
            (char)7356,
            (char)7368,
            (char)7369,
            (char)7370,
            (char)7371,
            (char)7372,
            (char)7373,
            (char)7374,
            (char)7375,
            (char)7419,
            (char)7420,
            (char)7421,
            (char)7422,
            (char)7423,
            (char)7958,
            (char)7959,
            (char)7966,
            (char)7967,
            (char)8006,
            (char)8007,
            (char)8014,
            (char)8015,
            (char)8024,
            (char)8026,
            (char)8028,
            (char)8030,
            (char)8062,
            (char)8063,
            (char)8117,
            (char)8133,
            (char)8148,
            (char)8149,
            (char)8156,
            (char)8176,
            (char)8177,
            (char)8181,
            (char)8191,
            (char)8293,
            (char)8306,
            (char)8307,
            (char)8335,
            (char)8349,
            (char)8350,
            (char)8351,
            (char)8385,
            (char)8386,
            (char)8387,
            (char)8388,
            (char)8389,
            (char)8390,
            (char)8391,
            (char)8392,
            (char)8393,
            (char)8394,
            (char)8395,
            (char)8396,
            (char)8397,
            (char)8398,
            (char)8399,
            (char)8433,
            (char)8434,
            (char)8435,
            (char)8436,
            (char)8437,
            (char)8438,
            (char)8439,
            (char)8440,
            (char)8441,
            (char)8442,
            (char)8443,
            (char)8444,
            (char)8445,
            (char)8446,
            (char)8447,
            (char)8588,
            (char)8589,
            (char)8590,
            (char)8591,
            (char)9255,
            (char)9256,
            (char)9257,
            (char)9258,
            (char)9259,
            (char)9260,
            (char)9261,
            (char)9262,
            (char)9263,
            (char)9264,
            (char)9265,
            (char)9266,
            (char)9267,
            (char)9268,
            (char)9269,
            (char)9270,
            (char)9271,
            (char)9272,
            (char)9273,
            (char)9274,
            (char)9275,
            (char)9276,
            (char)9277,
            (char)9278,
            (char)9279,
            (char)9291,
            (char)9292,
            (char)9293,
            (char)9294,
            (char)9295,
            (char)9296,
            (char)9297,
            (char)9298,
            (char)9299,
            (char)9300,
            (char)9301,
            (char)9302,
            (char)9303,
            (char)9304,
            (char)9305,
            (char)9306,
            (char)9307,
            (char)9308,
            (char)9309,
            (char)9310,
            (char)9311,
            (char)11124,
            (char)11125,
            (char)11158,
            (char)11508,
            (char)11509,
            (char)11510,
            (char)11511,
            (char)11512,
            (char)11558,
            (char)11560,
            (char)11561,
            (char)11562,
            (char)11563,
            (char)11564,
            (char)11566,
            (char)11567,
            (char)11624,
            (char)11625,
            (char)11626,
            (char)11627,
            (char)11628,
            (char)11629,
            (char)11630,
            (char)11633,
            (char)11634,
            (char)11635,
            (char)11636,
            (char)11637,
            (char)11638,
            (char)11639,
            (char)11640,
            (char)11641,
            (char)11642,
            (char)11643,
            (char)11644,
            (char)11645,
            (char)11646,
            (char)11671,
            (char)11672,
            (char)11673,
            (char)11674,
            (char)11675,
            (char)11676,
            (char)11677,
            (char)11678,
            (char)11679,
            (char)11687,
            (char)11695,
            (char)11703,
            (char)11711,
            (char)11719,
            (char)11727,
            (char)11735,
            (char)11743,
            (char)11870,
            (char)11871,
            (char)11872,
            (char)11873,
            (char)11874,
            (char)11875,
            (char)11876,
            (char)11877,
            (char)11878,
            (char)11879,
            (char)11880,
            (char)11881,
            (char)11882,
            (char)11883,
            (char)11884,
            (char)11885,
            (char)11886,
            (char)11887,
            (char)11888,
            (char)11889,
            (char)11890,
            (char)11891,
            (char)11892,
            (char)11893,
            (char)11894,
            (char)11895,
            (char)11896,
            (char)11897,
            (char)11898,
            (char)11899,
            (char)11900,
            (char)11901,
            (char)11902,
            (char)11903,
            (char)11930,
            (char)12020,
            (char)12021,
            (char)12022,
            (char)12023,
            (char)12024,
            (char)12025,
            (char)12026,
            (char)12027,
            (char)12028,
            (char)12029,
            (char)12030,
            (char)12031,
            (char)12246,
            (char)12247,
            (char)12248,
            (char)12249,
            (char)12250,
            (char)12251,
            (char)12252,
            (char)12253,
            (char)12254,
            (char)12255,
            (char)12256,
            (char)12257,
            (char)12258,
            (char)12259,
            (char)12260,
            (char)12261,
            (char)12262,
            (char)12263,
            (char)12264,
            (char)12265,
            (char)12266,
            (char)12267,
            (char)12268,
            (char)12269,
            (char)12270,
            (char)12271,
            (char)12284,
            (char)12285,
            (char)12286,
            (char)12287,
            (char)12352,
            (char)12439,
            (char)12440,
            (char)12544,
            (char)12545,
            (char)12546,
            (char)12547,
            (char)12548,
            (char)12592,
            (char)12687,
            (char)12772,
            (char)12773,
            (char)12774,
            (char)12775,
            (char)12776,
            (char)12777,
            (char)12778,
            (char)12779,
            (char)12780,
            (char)12781,
            (char)12782,
            (char)12783,
            (char)12831,
            (char)42125,
            (char)42126,
            (char)42127,
            (char)42183,
            (char)42184,
            (char)42185,
            (char)42186,
            (char)42187,
            (char)42188,
            (char)42189,
            (char)42190,
            (char)42191,
            (char)42540,
            (char)42541,
            (char)42542,
            (char)42543,
            (char)42544,
            (char)42545,
            (char)42546,
            (char)42547,
            (char)42548,
            (char)42549,
            (char)42550,
            (char)42551,
            (char)42552,
            (char)42553,
            (char)42554,
            (char)42555,
            (char)42556,
            (char)42557,
            (char)42558,
            (char)42559,
            (char)42744,
            (char)42745,
            (char)42746,
            (char)42747,
            (char)42748,
            (char)42749,
            (char)42750,
            (char)42751,
            (char)42955,
            (char)42956,
            (char)42957,
            (char)42958,
            (char)42959,
            (char)42962,
            (char)42964,
            (char)42970,
            (char)42971,
            (char)42972,
            (char)42973,
            (char)42974,
            (char)42975,
            (char)42976,
            (char)42977,
            (char)42978,
            (char)42979,
            (char)42980,
            (char)42981,
            (char)42982,
            (char)42983,
            (char)42984,
            (char)42985,
            (char)42986,
            (char)42987,
            (char)42988,
            (char)42989,
            (char)42990,
            (char)42991,
            (char)42992,
            (char)42993,
            (char)43053,
            (char)43054,
            (char)43055,
            (char)43066,
            (char)43067,
            (char)43068,
            (char)43069,
            (char)43070,
            (char)43071,
            (char)43128,
            (char)43129,
            (char)43130,
            (char)43131,
            (char)43132,
            (char)43133,
            (char)43134,
            (char)43135,
            (char)43206,
            (char)43207,
            (char)43208,
            (char)43209,
            (char)43210,
            (char)43211,
            (char)43212,
            (char)43213,
            (char)43226,
            (char)43227,
            (char)43228,
            (char)43229,
            (char)43230,
            (char)43231,
            (char)43348,
            (char)43349,
            (char)43350,
            (char)43351,
            (char)43352,
            (char)43353,
            (char)43354,
            (char)43355,
            (char)43356,
            (char)43357,
            (char)43358,
            (char)43389,
            (char)43390,
            (char)43391,
            (char)43470,
            (char)43482,
            (char)43483,
            (char)43484,
            (char)43485,
            (char)43519,
            (char)43575,
            (char)43576,
            (char)43577,
            (char)43578,
            (char)43579,
            (char)43580,
            (char)43581,
            (char)43582,
            (char)43583,
            (char)43598,
            (char)43599,
            (char)43610,
            (char)43611,
            (char)43715,
            (char)43716,
            (char)43717,
            (char)43718,
            (char)43719,
            (char)43720,
            (char)43721,
            (char)43722,
            (char)43723,
            (char)43724,
            (char)43725,
            (char)43726,
            (char)43727,
            (char)43728,
            (char)43729,
            (char)43730,
            (char)43731,
            (char)43732,
            (char)43733,
            (char)43734,
            (char)43735,
            (char)43736,
            (char)43737,
            (char)43738,
            (char)43767,
            (char)43768,
            (char)43769,
            (char)43770,
            (char)43771,
            (char)43772,
            (char)43773,
            (char)43774,
            (char)43775,
            (char)43776,
            (char)43783,
            (char)43784,
            (char)43791,
            (char)43792,
            (char)43799,
            (char)43800,
            (char)43801,
            (char)43802,
            (char)43803,
            (char)43804,
            (char)43805,
            (char)43806,
            (char)43807,
            (char)43815,
            (char)43823,
            (char)43884,
            (char)43885,
            (char)43886,
            (char)43887,
            (char)44014,
            (char)44015,
            (char)44026,
            (char)44027,
            (char)44028,
            (char)44029,
            (char)44030,
            (char)44031,
            (char)55204,
            (char)55205,
            (char)55206,
            (char)55207,
            (char)55208,
            (char)55209,
            (char)55210,
            (char)55211,
            (char)55212,
            (char)55213,
            (char)55214,
            (char)55215,
            (char)55239,
            (char)55240,
            (char)55241,
            (char)55242,
            (char)55292,
            (char)55293,
            (char)55294,
            (char)55295,
            (char)64110,
            (char)64111,
            (char)64218,
            (char)64219,
            (char)64220,
            (char)64221,
            (char)64222,
            (char)64223,
            (char)64224,
            (char)64225,
            (char)64226,
            (char)64227,
            (char)64228,
            (char)64229,
            (char)64230,
            (char)64231,
            (char)64232,
            (char)64233,
            (char)64234,
            (char)64235,
            (char)64236,
            (char)64237,
            (char)64238,
            (char)64239,
            (char)64240,
            (char)64241,
            (char)64242,
            (char)64243,
            (char)64244,
            (char)64245,
            (char)64246,
            (char)64247,
            (char)64248,
            (char)64249,
            (char)64250,
            (char)64251,
            (char)64252,
            (char)64253,
            (char)64254,
            (char)64255,
            (char)64263,
            (char)64264,
            (char)64265,
            (char)64266,
            (char)64267,
            (char)64268,
            (char)64269,
            (char)64270,
            (char)64271,
            (char)64272,
            (char)64273,
            (char)64274,
            (char)64280,
            (char)64281,
            (char)64282,
            (char)64283,
            (char)64284,
            (char)64311,
            (char)64317,
            (char)64319,
            (char)64322,
            (char)64325,
            (char)64451,
            (char)64452,
            (char)64453,
            (char)64454,
            (char)64455,
            (char)64456,
            (char)64457,
            (char)64458,
            (char)64459,
            (char)64460,
            (char)64461,
            (char)64462,
            (char)64463,
            (char)64464,
            (char)64465,
            (char)64466,
            (char)64912,
            (char)64913,
            (char)64968,
            (char)64969,
            (char)64970,
            (char)64971,
            (char)64972,
            (char)64973,
            (char)64974,
            (char)64976,
            (char)64977,
            (char)64978,
            (char)64979,
            (char)64980,
            (char)64981,
            (char)64982,
            (char)64983,
            (char)64984,
            (char)64985,
            (char)64986,
            (char)64987,
            (char)64988,
            (char)64989,
            (char)64990,
            (char)64991,
            (char)64992,
            (char)64993,
            (char)64994,
            (char)64995,
            (char)64996,
            (char)64997,
            (char)64998,
            (char)64999,
            (char)65000,
            (char)65001,
            (char)65002,
            (char)65003,
            (char)65004,
            (char)65005,
            (char)65006,
            (char)65007,
            (char)65050,
            (char)65051,
            (char)65052,
            (char)65053,
            (char)65054,
            (char)65055,
            (char)65107,
            (char)65127,
            (char)65132,
            (char)65133,
            (char)65134,
            (char)65135,
            (char)65141,
            (char)65277,
            (char)65278,
            (char)65280,
            (char)65471,
            (char)65472,
            (char)65473,
            (char)65480,
            (char)65481,
            (char)65488,
            (char)65489,
            (char)65496,
            (char)65497,
            (char)65501,
            (char)65502,
            (char)65503,
            (char)65511,
            (char)65519,
            (char)65520,
            (char)65521,
            (char)65522,
            (char)65523,
            (char)65524,
            (char)65525,
            (char)65526,
            (char)65527,
            (char)65528,
            (char)65534,
            (char)65535,
  
           ];

        /// <summary>
        /// Chars that are invalid in Windows and MacOs file names
        /// </summary>
        public static readonly char[] InvalidCharsInWindowsAndMacOsFileNames = InvalidCharsInWindowsFileNames.Concat(InvalidCharsInMacOsFileNames).ToArray();


        /// <summary>
        /// These chars are invalid in Windows file names
        /// </summary>
        public static readonly string[] InvalidTrailingChars = [".", " "];

        /// <summary>
        /// These chars are invalid in Unix file names
        /// </summary>

        public static readonly char[] InvalidCharsInUnixFileNames = ['/', '\0'];
        /// <summary>
        /// FallbackFileName is used in cases where the sanitized file name would result in an empty string.
        /// </summary>
        public static readonly string FallbackFileName = "FileName";

        /// <summary>
        /// Sanitizes a filename by replacing invalid chars with a replacement char. Follows rules defined in https://docs.microsoft.com/en-us/windows/win32/fileio/naming-a-file
        /// </summary>
        /// <param name="filename"></param>
        /// <param name="replacement"></param>
        /// <returns></returns>
        public static string Sanitize(string filename, char replacement = '_')
        {
            ReplacementSanityCheck(replacement);

            string saneFilename = InternalSanitize(filename, replacement);
            return UnicodeSafeStringTruncate(saneFilename);
        }

        /// <summary>
        /// Sanitizes a filename by replacing invalid chars with a replacement char. Follows rules defined in https://docs.microsoft.com/en-us/windows/win32/fileio/naming-a-file
        /// </summary>
        /// <param name="filename"></param>
        /// <param name="replacement"></param>
        /// <returns></returns>
        public static string Sanitize(string filename, string replacement)
        {
            if (char.TryParse(replacement, out var replacementChar))
                ReplacementSanityCheck(replacementChar);

            string saneFilename = InternalSanitize(filename, replacement);
            return UnicodeSafeStringTruncate(saneFilename);
        }

        private static void ReplacementSanityCheck(char replacement)
        {
            if (InvalidCharsInUnixFileNames.Contains(replacement))
                throw new ArgumentException($"Replacement '{replacement}' is invalid for Unix", nameof(replacement));

            if (InvalidCharsInWindowsFileNames.Contains(replacement))
                throw new ArgumentException($"Replacement '{replacement}' is invalid for Windows", nameof(replacement));

            if (InvalidCharsInMacOsFileNames.Contains(replacement))
                throw new ArgumentException($"Replacement '{replacement}' is invalid for MacOs", nameof(replacement));
        }

        private static string InternalSanitize(string filename, char replacement)
        {
            return InternalSanitize(filename, replacement.ToString());
        }

        private static string InternalSanitize(string filename, string replacement)
        {

            var invalidCharsFileNamesSanitized = InternalSanitizeChars(filename, replacement, InvalidCharsInWindowsAndMacOsFileNames);
            //var invalidCharsFileNamesSanitized = InternalSanitizeChars(filename, replacement, InvalidCharsInWindowsFileNames);
            var reservedFileNamesSanitized = InternalSanitizeReservedFileNames(invalidCharsFileNamesSanitized, $"{replacement}");
            var reservedFileNamePrefixSanitized = InternalSanitizeReservedFileNamePrefix(reservedFileNamesSanitized, $"{replacement}");
            var trailingCharSanitized = RemoveTrailingPeriodOrSpace(reservedFileNamePrefixSanitized, $"{replacement}");

            if (string.IsNullOrEmpty(trailingCharSanitized) || trailingCharSanitized == " " || trailingCharSanitized == ".")
                return FallbackFileName;

            if (trailingCharSanitized == filename)
                return trailingCharSanitized;

            return InternalSanitize(trailingCharSanitized, replacement);
        }

        private static string InternalSanitizeChars(string filename, string replacement, char[]? invalidChars = null)
        {
            var usedInvalidChars = invalidChars ?? Path.GetInvalidFileNameChars();

            foreach (var invalidChar in usedInvalidChars)
                filename = filename.Replace(invalidChar.ToString(), replacement, StringComparison.Ordinal);

            filename = ReplaceInvalidUnicodeChars(filename, replacement);
            filename = RemoveUnpairedSurrogates(filename);

            return filename;
        }

        // replace invalid unicode characters with a replacement character (they were failing on github runner using ubuntu)
        private static string ReplaceInvalidUnicodeChars(string input, string replacement)
        {
            var validChars = new StringBuilder();

            foreach (char c in input)
            {
                if (c <= 0x10FFFF)
                {
                    validChars.Append(c);
                }
                else
                {
                    validChars.Append(replacement);
                }
            }

            return validChars.ToString();
        }

        /// <summary>
        /// Removes unpaired surrogates from a string (Ubuntu does not like that)
        /// </summary>
        /// <param name="input"></param>
        /// <returns></returns>
        public static string RemoveUnpairedSurrogates(string input)
        {
            if (string.IsNullOrEmpty(input))
                return input;

            var result = new StringBuilder();

            for (int i = 0; i < input.Length; i++)
            {
                if (char.IsHighSurrogate(input[i]) && (i < input.Length - 1 && char.IsLowSurrogate(input[i + 1])))
                {
                    // High surrogate is followed by a low surrogate
                    result.Append(input[i]);
                    result.Append(input[i + 1]);
                    // Skip the next character
                    i++;
                }
                else if (char.IsLowSurrogate(input[i]) && (i > 0 && char.IsHighSurrogate(input[i - 1])))
                {
                    // Low surrogate is preceded by a high surrogate
                    result.Append(input[i]);
                }
                else if (!char.IsSurrogate(input[i]))
                {
                    // Not a surrogate
                    result.Append(input[i]);
                }
            }

            return result.ToString();
        }

        private static string InternalSanitizeReservedFileNames(string filename, string replacement)
        {
            foreach (var reservedFileName in ReservedWindowsFileNames)
                filename = filename.Replace(reservedFileName, replacement, true, CultureInfo.InvariantCulture);

            return filename;
        }

        private static string InternalSanitizeReservedFileNamePrefix(string filename, string replacement)
        {
            foreach (var reservedFileNamePrefix in ReservedWindowsFileNamesWithExtension)
                if (filename.StartsWith(reservedFileNamePrefix, true, CultureInfo.InvariantCulture))
                    filename = string.Concat(replacement, filename.AsSpan(0, reservedFileNamePrefix.Length));

            return filename;
        }

        private static string RemoveTrailingPeriodOrSpace(string filename, string replacement)
        {
            foreach (var InvalidTrailingChar in InvalidTrailingChars)
                if (filename.EndsWith(InvalidTrailingChar, true, CultureInfo.InvariantCulture))
                    return filename[..^1] + replacement;

            return filename;
        }

        static string UnicodeSafeStringTruncate(string longFileName)
        {
            // Most filenames are shorter than 255 bytes, so we can avoid the expensive string enumeration in most cases
            if (FileNameLengthIsExt4Compatible(longFileName))
            {
                return longFileName;
            }

            var builder = new StringBuilder();
            var builderForward = new StringBuilder();

            var textElementEnumerator = StringInfo.GetTextElementEnumerator(longFileName);

            while (textElementEnumerator.MoveNext())
            {
                builderForward.Append(textElementEnumerator.Current);

                // Rule working for EXT4 and most other file systems
                if (!FileNameLengthIsExt4Compatible(builderForward.ToString()))
                {
                    return builder.ToString();
                }

                builder.Append(textElementEnumerator.Current);
            }

            return longFileName;
        }

        private static bool FileNameLengthIsExt4Compatible(string longFileName)
        {
            // Rule that would be working for NTFS
            //longFileName.Length <= 255

            return Encoding.UTF8.GetByteCount(longFileName) <= 255;
        }
    }
}

